# (Replace the existing Prepare .sdPlugin bundle step with the block below)
      - name: Prepare .sdPlugin bundle
        run: |
          # Keep failure non-fatal for decode; handle decode errors gracefully
          BUNDLE_DIR=StreamDeckSmartThings.sdPlugin
          rm -rf "$BUNDLE_DIR"
          mkdir -p "$BUNDLE_DIR"
          cp manifest.json "$BUNDLE_DIR/"
          cp README.md "$BUNDLE_DIR/" || true
          cp package.json "$BUNDLE_DIR/" || true
          cp propertyinspector.html "$BUNDLE_DIR/" || true
          cp propertyinspector.js "$BUNDLE_DIR/" || true
          cp plugin.html "$BUNDLE_DIR/" || true
          cp -R src "$BUNDLE_DIR/" || true

          if [ -d images ]; then
            echo "images/ directory found — processing .base64 files (if any)"
            for f in images/*.base64; do
              [ -f "$f" ] || continue
              out="${f%.base64}.png"
              if [ -f "$out" ]; then
                echo "PNG already exists for $f, skipping decode"
                continue
              fi
              tmp="$(mktemp)"
              sed 's/^data:.*;base64,//I; s/[^A-Za-z0-9+\/=]//g' "$f" | base64 --decode > "$tmp" 2>/dev/null || {
                echo "Warning: base64 decode failed for $f — skipping"
                rm -f "$tmp"
                continue
              }
              magic="$(hexdump -n8 -v -e '/1 \"%02x\"' "$tmp" 2>/dev/null || true)"
              if echo "$magic" | grep -iq '^89504e470d0a1a0a'; then
                mv "$tmp" "$out"
                echo "Decoded $f -> $out (valid PNG)"
              else
                echo "Warning: decoded data from $f is not a PNG (magic: $magic) — skipping"
                rm -f "$tmp"
                continue
              fi
            done
            cp -R images "$BUNDLE_DIR/" || true
          fi
          ls -la "$BUNDLE_DIR"
